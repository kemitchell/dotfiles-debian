#!/bin/bash
set -e

REPOS=$(list-git-repos "$HOME")

HAVE_DIRTY=""
for dir in $REPOS; do
  if (cd "$dir" && cd .. && git-tree-is-dirty); then
    echo "$dir tree is dirty!" >/dev/stderr
    HAVE_DIRTY="1"
  fi
done

if [ ! -z "$HAVE_DIRTY" ]; then
  exit 1
fi

parallel -j 4 git -C {} push --all --quiet <<< "$REPOS"
# xargs -P 0 -I {} git -C {} push --all --quiet <<< "$REPOS"
