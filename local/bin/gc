#!/usr/bin/zsh
function usage {
  cat <<EOS
Interactively select and clone a Git repository.

Usage: gc [options]

Options:
  -c --cache      Cache the repository.
  -r --refresh    Refresh the remote cache.
  -s --shallow    Shallow clone.
  -h --help       Show help.
EOS
}

while test $# != 0; do
  case "$1" in
  -r | --refresh) refresh_flag=t ;;
  -c | --cache) cache_flag=t ;;
  -s | --shallow) shallow_flag=t ;;
  -h | --help) usage ; exit ;;
  *)  usage ; exit 1 ;;
  esac
  shift
done

GITHUB_SLUGS="$HOME/.github-my-repos"
SOURCEHUT_SLUGS="$HOME/.sourcehut-my-repos"
OTHER_REMOTES="$HOME/.git-my-repos"
if [ -n "$refresh_flag" ]; then
  refreshgithubcache
  refreshsourcehutcache
  refreshgitcache
fi

remote=$(
  (
    cat "$GITHUB_SLUGS" | awk '{print "git@github.com:" $1}'
    cat "$SOURCEHUT_SLUGS" | awk '{print "git@git.sr.ht:" $1}'
    cat "$OTHER_REMOTES"
  ) | fzf
)
if [ -z "$remote" ]; then
  exit 1
fi

flags=""
if [ -n "$shallow_flag" ]; then
  flags="--shallow"
fi
if [ -n "$cache_flag" ]; then
  flags="$flags --cache"
fi
clone $flags "$remote"
