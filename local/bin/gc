#!/usr/bin/zsh
cd

CACHE="$HOME/.github-my-repos"

if [[ ! -f "$CACHE" || $* == *--refresh* || $* == *-r* ]]
then
  github-my-repos | sort > "$CACHE"
  if [ -f "$HOME/.repos" ]; then
    cat "$HOME/.repos" >> "$CACHE"
  fi
fi

remote=$((cat "$CACHE" | awk '{print "git@github.com:" $1}' ; cat "$HOME/.git-my-repos") | selecta)
slug=$(echo -n $remote | cut -f 2 -d ':')
base=$(basename "$slug")

git clone "$remote" "$base"

(
  cd "$base"
  git submodule update --init --recursive
  ssb=$(fgrep "$slug" "$HOME/.github-to-ssb" | cut -d ' ' -f 2)
  # if [ -f package.json ]; then
  #   npm install
  # fi
  if git remote -v | fgrep "github" > /dev/null; then
    gh issue
  fi
  git grep "TODO"
)

if [ -f "$HOME/$base/Gopkg.toml" ]; then
  destination="$GOPATH/src/github.com/$slug"
  if [ -d "$destination" ]; then
    rm -rf "$HOME/$base"
  else
    mkdir -p $(dirname "$destination")
    mv "$HOME/$base" $(dirname "$destination")
  fi
  echo "$destination"
fi
