#!/bin/sh
set -e

REPO="$HOME/scraps"

# If the repository hasn't been cloned yet, clone it.
if [ ! -d "$REPO" ]; then
  git clone git@github.com:kemitchell/scraps "$REPO"
fi

cd "$REPO"

# Determine the editor command to call.
# EDIT_WITH="${VISUAL:-"${EDITOR:-vi}"}"

# If there wasn't any argument, get one by listing all files in the
# repository and selecting with selecta.
if [ -z "$1" ]; then
  FILE=$(git ls-files | selecta)
else
  FILE="$1"
fi

# If the scrap file doesn't exist yet, create it.
if [ ! -f "$FILE" ]; then
  touch "$FILE"
fi

# Save a copy of the file before editing.
TMP=$(mktemp)
trap 'rm -rf "$TMP"' EXIT
cp "$FILE" "$TMP"

# Invoke the editor.
vim -c 'call WrapSettings()' "$FILE"

# If the file was changed, commit and push.
if cmp "$TMP" "$FILE"; then
  exit 0
else
  git add "$FILE"
  git empty
  git push
  exit 0
fi
