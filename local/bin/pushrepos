set -e

REPOS=$(listgitrepos "$HOME")

HAVE_DIRTY=""
for dir in $REPOS; do
  if (cd "$dir" && cd .. && gittreeisdirty); then
    echo "$dir tree is dirty!" >/dev/stderr
    HAVE_DIRTY="1"
  fi
done

if [ ! -z "$HAVE_DIRTY" ]; then
  exit 1
fi

if [ ! -z "$REPOS" ]; then
  echo "$REPOS" | parallel -j 4 git -C {} push --all --quiet
fi
# xargs -P 0 -I {} git -C {} push --all --quiet <<< "$REPOS"
