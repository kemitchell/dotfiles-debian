#!/bin/bash
set -e

REPOS=$(listgitrepos "$HOME")

HAVE_DIRTY=""
for dir in $REPOS; do
  if (cd "$dir" && cd .. && gittreeisdirty); then
    echo "$dir tree is dirty!" >/dev/stderr
    HAVE_DIRTY="1"
  fi
done

if [ ! -z "$HAVE_DIRTY" ]; then
  exit 1
fi

if [ ! -z "$REPOS" ]; then
  echo "$REPOS" | parallel --retry-failed -j 0 git -C {} push --all --quiet
fi
